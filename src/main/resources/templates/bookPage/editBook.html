<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../layui/css/layui.css" th:href="@{/layui/css/layui.css}"/>
    <link rel="stylesheet" href="../css/common.css" th:href="@{/css/common.css}" />
    <style>
        .label-text{
            margin-left: -20px;
           }
    </style>
</head>

<body>
<!--搜索条件-->
<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
    <legend>根据条件查询</legend>
</fieldset>
<div class="layui-form" action="">
<div class="layui-form-item layui-inline label-text">
    <label class="layui-form-label " >编号:</label>
    <div class="layui-input-block">
        <input type="text" name="title" id="bookNumber"  lay-verify="title" autocomplete="off" placeholder="" class="layui-input">
    </div>
</div>
    <div class="layui-form-item layui-inline label-text">
        <label class="layui-form-label ">书名:</label>
        <div class="layui-input-block">
            <input type="text" name="title" id="bookName" lay-verify="title" autocomplete="off" placeholder="" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item layui-inline">
        <label class="layui-form-label ">作者:</label>
        <div class="layui-input-block">
            <input type="text" name="title" id="bookAuthor" lay-verify="title" autocomplete="off" placeholder="" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item layui-inline label-text">
        <label class="layui-form-label ">出版社:</label>
        <div class="layui-input-block">
            <input type="text" name="title" id="publish" lay-verify="title" autocomplete="off" placeholder="" class="layui-input">
        </div>
    </div>
        <div class="layui-form-item layui-inline label-text">
            <label class="layui-form-label ">类型:</label>
            <div class="layui-input-block">
                <input type="text" name="title" id="classifi" lay-verify="title" autocomplete="off" placeholder="" class="layui-input">
            </div>
        </div>
    <div class="layui-form-item layui-inline">
        <label class="layui-form-label">是否借出：</label>
        <div class="layui-input-block">
            <input type="radio" name="state" value="0" title="是">
            <input type="radio" name="state" value="1" title="否" >
        </div>
    </div>
<!--        <div class="layui-form-item layui-inline label-text">-->
<!--            <label class="layui-form-label ">是否借出:</label>-->
<!--            <div class="layui-input-block">-->
<!--                <input type="text" name="title" id="rent" lay-verify="title" autocomplete="off" placeholder="(填是或否)" class="layui-input">-->
<!--            </div>-->
<!--        </div>-->
        <div class="layui-form-item" style="text-align: center">
            <div class="layui-input-block">
                <button class="layui-btn" id="btn_submit" lay-submit lay-filter="formDemo"><i class="layui-icon layui-icon-search"></i>搜索</button>
                <button type="reset" id="btn_reset" class="layui-btn layui-btn-primary"><i class="layui-icon layui-icon-refresh"></i>重置</button>
            </div>
        </div>
    </div>
<!--</div>-->
<!--layui渲染表格开始-->

<!--数据表格-->
    <table class="layui-hide" id="dataTemplate" lay-filter="dataTemplate" ></table>

<!--行内操作-->
    <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-warm layui-btn-sm" lay-event="detail"><i class="layui-icon layui-icon-read"></i>预览</a>
        <a class="layui-btn layui-btn-sm" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
        {{#  if(d.state === 1){ }}
        <a class="layui-btn layui-btn-danger layui-btn-sm" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</a>
        {{#  } }}
    </script>

<!--头部操作-->
    <script type="text/html" id="title-barDemo">
        <a class="layui-btn layui-btn-danger layui-btn-sm" lay-event="delete"><i class="layui-icon layui-icon-delete"></i>删除</a>
    </script>
<!--layui渲染表格结束-->

<!--书籍信息弹窗-->
<script id="book-info" type="text/html">
    <div class="layui-form layui-form-pane" >
        <div class="layui-form-item">
            <label class="layui-form-label">图书编号</label>
            <div class="layui-input-block">
                <input type="text" id="book_number" value="{{d.book_number}}" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">书名</label>
            <div class="layui-input-block">
                <input type="text" id="book_name" value="{{d.book_name}}" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">作者</label>
            <div class="layui-input-block">
                <input type="text" id="author" value="{{d.author}}" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">出版社</label>
            <div class="layui-input-block">
                <input type="text" id="publisher"  value="{{d.publisher}}" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">出版时间</label>
            <div class="layui-input-block">
                <input type="text"  id="publish_time"  value="{{d.publish_time}}"  class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">分类</label>
            <div class="layui-input-block">
                <input type="text" id="classification" value="{{d.classification}}" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">状态</label>
            <div class="layui-input-block">
                <input type="text" id="state" readonly value="{{d.state}}" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item" >
            <label class="layui-form-label ">简介</label>
            <div class="layui-input-block">
                <textarea type="text" id="introduce" style="height: 200px;" class="layui-textarea">{{d.introduce}}</textarea>
            </div>
        </div>
        </div>
</script>
<div id="book-info-model" style="display: none"></div>


<script type="text/javascript"  src="../static/layui/layui.js" th:src="@{/layui/layui.js}"></script>
<script type="text/javascript" src="../static/js/common.js" th:src="@{/js/common.js}"></script>
<script type="text/javascript"  src="../static/js/jquery-3.1.1.min.js" th:src="@{/js/jquery-3.1.1.min.js}" ></script>
<script type="text/javascript">

    layui.use(['table','laytpl','laydate','layer','util','form'], function(){
        var table = layui.table;
        var laytpl = layui.laytpl;
        var util = layui.util;
        let layer = layui.layer;
        var laydate = layui.laydate;
        let form = layui.form;



        //=====================数据表格=========================
        table.render({
            elem: '#dataTemplate', //容器id
            // height: 312, //容器高度
            even: true, //隔行变色
            id:'table_overload',
            toolbar:"#title-barDemo",
            defaultToolbar: [],//隐藏表格右上角工具
            url: '/bookController/allBook', //数据接口
            cols: [
                      [
                        {checkbox: true, fixed: true},
                        {field: 'book_id', title: '图书id',hide:true, sort: true},
                        {field: 'book_number', title: '图书编号',width: 160, sort: true},
                        {field: 'book_name', title: '书名',width: 160},
                        {field: 'author', title: '作者', width: 160,sort: true},
                        {field: 'publisher', title: '出版社',width: 160},
                        {field: 'publish_time', title: '出版时间',templet:function(d){return util.toDateString(d.publish_time, "yyyy-MM-dd");},width: 160},
                        {field: 'classification', title: '分类',width: 160, sort: true},
                        {field: 'state', title: '状态',
                            templet:function(d){
                                if (d.state === 0){
                                    return "借出"
                                }else{
                                    return "未借出";
                                }
                            },
                            sort: true,
                            width: 80
                        },
                        {field: 'introduce', title: '简介'},
                        {fixed: 'right', title: '操作',width:178, align:'left',width: 300, toolbar: '#barDemo'}
                      ]
                   ],
            page: {
                layout: ['count', 'prev', 'page', 'next',  'skip'],
                groups:3 ,
                prev: '<<上一页',
                next:'下一页>>'
            },
            limit:10
        });

        //=============监听行内工具=============================
        table.on('tool(dataTemplate)',function (obj) {
            let data = obj.data;
            let event = obj.event;

           var dataFrm= function(data){
                return util.toDateString(data, "yyyy-MM-dd");
            }
            if (event === 'detail'){
                //预览
                yu_lanTool(data)

            }else if (event === 'edit'){
                //编辑
                editTool(data)

            }else if (event === 'del'){
                //删除
                let dataStr = {
                    "ids": data.book_id + ''
                }
                delTool(data , obj,dataStr)
                console.log(data.book_id+"删除")
            }
        })

        //=============监听头部工具=================
        table.on('toolbar(dataTemplate)', function(obj){
            var checkStatus = table.checkStatus(obj.config.id);
            switch(obj.event){
                case 'delete':
                    let str = ''
                    let data = checkStatus.data;
                    for (k in data){
                        if (k == (data.length-1)){
                            str += data[k].book_id;
                        }else {
                            str += data[k].book_id+',';
                        }

                    }
                    if (str === ''){
                        layer.msg("请选择要删除的书籍")
                    }else {
                        let dataStr = {
                            "ids":str
                        }
                        layer.confirm('确定删除？', function (index) {
                            $.ajax({
                                type: 'get',
                                url: '/bookController/deleteBook',
                                contentType: 'application/json',
                                data: dataStr,
                                success: function (result) {
                                    if (result > 0) {
                                        table.reload('table_overload');
                                        layer.close(index);
                                        layer.msg("删除成功！")
                                    } else if( result === -1){
                                        layer.close(index);
                                        layer.msg("删除失败！其中包含未归还书籍")
                                    }
                                }
                            })
                        });
                    }
                    break;
            };
        });

        //============行工具预览=======================
        function yu_lanTool(data) {
            if (data.state === 0){
                data.state = "借出"
            }else{
                data.state = "未借出";
            }
            laytpl($('#book-info').html()).render(data,function(html){
                $('#book-info-model').html(html)
            })
            layer.open({
                skin: 'layui-layer-molv',
                type: 1,
                area: ['500px', '700px'],
                btn: ['关闭'],
                title:'书籍预览',
                content: $('#book-info-model'),
                success:function(){
                    laydate.render({
                        elem: '#publish_time', //指定元素data.publish_time
                        value:util.toDateString(data.publish_time, "yyyy-MM-dd")
                    });

                },

            });
        }

        //============行工具编辑=======================
        function editTool(data) {
            if (data.state === 0){
                data.state = "借出"
            }else{
                data.state = "未借出";
            }
            laytpl($('#book-info').html()).render(data,function(html){
                $('#book-info-model').html(html)
            })
            layer.open({
                skin: 'layui-layer-molv',
                type: 1,
                area: ['500px', '700px'],
                btn: ['修改','关闭'],
                title:'书籍预览',
                content: $('#book-info-model'),
                success:function(){
                    laydate.render({
                        elem: '#publish_time', //指定元素data.publish_time
                        value:util.toDateString(data.publish_time, "yyyy-MM-dd")
                    });

                },
                yes:function (index, layero) {
                    let book_number = $('#book_number').val();
                    let book_name = $('#book_name').val();
                    let author =$('#author').val();
                    let publisher =$('#publisher').val();
                    let publish_time =$('#publish_time').val();
                    let classification =$('#classification').val();

                    let introduce =$('#introduce').val();
                    let bookId = data.book_id;
                    let state ;
                   if ($('#state').val() ==='借出') {
                       state = 0;
                   }else {
                       state =1;
                   }

                    if(book_number == data.book_number){
                        book_number = "book_number";
                    }

                    console.log(publish_time)
                    let dataStr = {
                        "book_id":bookId,
                        "book_number": book_number,
                        "book_name": book_name,
                        "author": author,
                        "publisher": publisher,
                        "publish_time": publish_time,
                        "classification": classification ,
                        "state": state ,
                        "introduce": introduce
                    };
                    $.ajax({
                        type:'post',
                        url:'/bookController/updateBook',
                        data:JSON.stringify(dataStr),
                        contentType:'application/json',
                        success:function (data) {
                            if (data == '1'){
                                layer.msg('图书编号已经存在');

                            }else if (data == '0'){
                                table.reload('table_overload');
                                layer.msg('修改成功');
                            }else {
                                layer.msg('添加失败');
                            }
                        }

                    })

                    layer.close(index)
                }
            });
        }

        //===========行和头部工具删除===================
        function delTool(data,obj,dataStr) {
            layer.confirm('确定删除？', function (index) {
                $.ajax({
                    type: 'get',
                    url: '/bookController/deleteBook',
                    contentType: 'application/json',
                    data: dataStr,
                    success: function (result) {
                        if (result > 0) {
                            obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                            layer.close(index);
                            layer.msg("删除成功！")
                        } else {
                            layer.close(index);
                            layer.msg("删除失败！")
                        }
                    }
                })
            });
        }

        //==================按条件查询事件======================
        $('#btn_submit').click(function () {
            let state ;
            if ($("input[name='state']:checked").val() === undefined){
                state = null;
            }else {
                if ($("input[name='state']:checked").val() === "0"){
                    state = 0;
                }else if ($("input[name='state']:checked").val() === "1"){
                    state =1;
                }
            }
            let book={
                "book_number" : $('#bookNumber').val(),
                "book_name": $('#bookName').val(),
                "author" : $('#bookAuthor').val(),
                "classification" : $('#classifi').val(),
                "publisher" :$('#publish').val(),
                "state":state
            };
            table.reload('table_overload',{
                url:'/bookController/selectBook',
                where:book,
            })
        })

        $('#btn_reset').click(function () {
             $('#bookNumber').val(''),
             $('#bookName').val(''),
             $('#bookAuthor').val(''),
             $('#classifi').val(''),
             $('#publish').val(''),
             $("input[name='state']").each(function (i) {
                 $(this).prop('checked',false)
             });
            form.render()
        })

    });

</script>
</body>
</html>